require 'fileutils'
require 'yaml'

add_extra_platforms(
  platforms: [:windows]
)

default_platform(:android)

platform :ios do
  desc "Ensures flutter is installed"
  lane :bootstrap do
    flutter_bootstrap(flutter_channel: 'stable')
  end

  desc "Build ipa file"
  lane :build do
    flutter_build(
        build_args: ['--no-codesign'],
        build: 'ipa',
    )
  end
end

platform :android do
  desc "Ensures flutter is installed"
  lane :bootstrap do
    flutter_bootstrap(
      flutter_channel: 'stable',
      android_licenses: {
        'android-sdk-license' => '24333f8a63b6825ea9c5514f83c2829b004d1fee',
      },
    )
  end

  desc "Build apk file"
  lane :build do
    flutter_build(build: 'apk')
  end

  desc "Writes playstore changelogs from Changelog.md"
  lane :changelog do
    populate_changelogs
  end

  desc "Build appbundle and upload to playstore"
  lane :deploy do
    populate_changelogs
    flutter_build(build: 'appbundle')
    build_number = fetch_current_version.split("+")[1]
    upload_to_play_store(
      aab: "build/app/outputs/bundle/release/app-release.aab",
      version_code: build_number,
    )
  end
end

def fetch_current_version
    YAML.safe_load(File.read('../pubspec.yaml'))['version']
end

def fetch_versions
  path = "../CHANGELOG.md"
  content = File.read(path)
  regex = /## \[(.+\+\d+)\]/
  content.scan(regex).map(&:first)
end

def populate_changelogs
  changelogs = "./metadata/android/en-US/changelogs"
  FileUtils.mkdir_p(changelogs)
  fetch_versions.each do |version|
    build_number = version.split("+")[1]
    File.open("#{changelogs}/#{build_number}.txt", 'w') do |f|
      full_changelog = read_changelog(section_identifier: "[#{version}]")
      f << strip_links_from_changelog(full_changelog)
    end
  end
end

# removes the unwanted link section from the changelog
def strip_links_from_changelog(changelog)
  changelog.split("\n").reject do |line|
    line =~ /^\[\d+\.\d+\.\d+(\+\d+)?\]:\s*https?:\/\/.*$/
  end.join("\n")
end

# TODO: fix these lanes
platform :windows do
  desc "Ensures InnoSetup is installed"
  lane :bootstrap do
    sh("winget", "install", "--id", "JRSoftware.InnoSetup", "--silent", "--accept-package-agreements", "--accept-source-agreements", "--no-upgrade")
  end

  desc "Builds an exe installer with flutter_distributor and InnoSetup"
    lane :exe do
      sh(["flutter", "pub", "global", "activate", "flutter_distributor",])
      sh(["flutter_distributor", "package", "--platform", "windows", "--targets", "exe"])
    end
end